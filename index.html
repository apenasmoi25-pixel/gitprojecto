<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de √Ågua e Luz</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Calculadora de √Ågua e Luz</h1>
                <p class="text-sm md:text-base text-gray-600 mb-4">Gest√£o de contadores com c√°lculo autom√°tico</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportarDados()" class="flex-1 md:flex-none bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-green-700">
                        ‚¨áÔ∏è Exportar
                    </button>
                    <label class="flex-1 md:flex-none bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 cursor-pointer text-center">
                        ‚¨ÜÔ∏è Importar
                        <input type="file" id="importFile" accept=".json" onchange="importarDados(event)" class="hidden">
                    </label>
                    <button onclick="limparTudo()" class="flex-1 md:flex-none bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-red-700">
                        üóëÔ∏è Limpar Tudo
                    </button>
                </div>
            </div>
        </div>

        <!-- Aviso -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <p class="text-blue-800 text-sm"><strong>‚ÑπÔ∏è Nota:</strong> Os dados ficam guardados no seu navegador. Use Exportar/Importar para fazer backup ou partilhar dados.</p>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-lg mb-6">
            <div class="grid grid-cols-2 md:flex border-b">
                <button onclick="mudarTab('contadores')" id="tab-contadores" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold bg-indigo-600 text-white">
                    ‚öôÔ∏è Contadores
                </button>
                <button onclick="mudarTab('leituras')" id="tab-leituras" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50">
                    üìÖ Leituras
                </button>
                <button onclick="mudarTab('faturas')" id="tab-faturas" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50">
                    üí∂ Faturas
                </button>
                <button onclick="mudarTab('calculos')" id="tab-calculos" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50">
                    üßÆ Calcular
                </button>
            </div>

            <div class="p-4 md:p-6">
                <!-- Tab Contadores -->
                <div id="content-contadores">
                    <div class="space-y-8">
                        <!-- Contadores √Ågua -->
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">üíß Contadores de √Ågua</h2>
                            <div id="lista-agua" class="space-y-3 mb-4"></div>
                            <div class="flex gap-2">
                                <input type="text" id="nova-agua" placeholder="Nome do contador" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                                <button onclick="adicionarContadorAgua()" class="bg-blue-600 text-white px-4 md:px-6 py-2 rounded-lg text-sm md:text-base font-semibold hover:bg-blue-700 whitespace-nowrap">
                                    ‚ûï Adicionar
                                </button>
                            </div>
                        </div>

                        <!-- Contadores Luz -->
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">‚ö° Contadores de Luz</h2>
                            <div id="lista-luz" class="space-y-3 mb-4"></div>
                            <div class="flex gap-2">
                                <input type="text" id="nova-luz" placeholder="Nome do contador" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                                <button onclick="adicionarContadorLuz()" class="bg-yellow-600 text-white px-4 md:px-6 py-2 rounded-lg text-sm md:text-base font-semibold hover:bg-yellow-700 whitespace-nowrap">
                                    ‚ûï Adicionar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Leituras -->
                <div id="content-leituras" class="hidden">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">Registar Leitura Mensal</h2>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Data da Leitura</label>
                        <input type="date" id="data-leitura" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">üíß √Ågua (m¬≥)</h3>
                            <div id="inputs-agua" class="space-y-3"></div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">‚ö° Luz (kWh)</h3>
                            <div id="inputs-luz" class="space-y-3"></div>
                        </div>
                    </div>
                    <button onclick="registarLeitura()" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">
                        ‚ûï Registar Leitura
                    </button>
                    <div id="historico-leituras" class="mt-8"></div>
                </div>

                <!-- Tab Faturas -->
                <div id="content-faturas" class="hidden">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">Registar Fatura Mensal</h2>
                    <div class="max-w-2xl mx-auto">
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">M√™s de Refer√™ncia</label>
                            <input type="month" id="mes-fatura" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üíß Valor Total √Ågua (‚Ç¨)</label>
                            <input type="number" step="0.01" id="valor-agua" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚ö° Valor Total Luz (‚Ç¨)</label>
                            <input type="number" step="0.01" id="valor-luz" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <button onclick="registarFatura()" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">
                            ‚ûï Registar Fatura
                        </button>
                    </div>
                    <div id="historico-faturas" class="mt-8"></div>
                </div>

                <!-- Tab C√°lculos -->
                <div id="content-calculos" class="hidden">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">C√°lculo de Consumos e Custos</h2>
                    <div id="resultados-calculos"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados globais
        let dados = {
            contadoresAgua: [{ id: 1, descricao: 'Contador √Ågua 1' }],
            contadoresLuz: [{ id: 1, descricao: 'Contador Luz 1' }],
            leituras: [],
            faturas: []
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            carregarDados();
            document.getElementById('data-leitura').valueAsDate = new Date();
            const hoje = new Date();
            document.getElementById('mes-fatura').value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
        });

        // Carregar dados do localStorage
        function carregarDados() {
            try {
                const dadosGuardados = localStorage.getItem('calculadora-agua-luz');
                if (dadosGuardados) {
                    dados = JSON.parse(dadosGuardados);
                }
            } catch (e) {
                console.log('Erro ao carregar dados');
            }
            renderizar();
        }

        // Guardar dados no localStorage
        function guardarDados() {
            try {
                localStorage.setItem('calculadora-agua-luz', JSON.stringify(dados));
                return true;
            } catch (e) {
                alert('Erro ao guardar dados. Verifique o espa√ßo dispon√≠vel no navegador.');
                return false;
            }
        }

        // Mudar tab
        function mudarTab(tab) {
            ['contadores', 'leituras', 'faturas', 'calculos'].forEach(t => {
                document.getElementById(`tab-${t}`).className = 'py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50';
                document.getElementById(`content-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${tab}`).className = 'py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold bg-indigo-600 text-white';
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            
            if (tab === 'leituras') renderizarInputsLeituras();
            if (tab === 'calculos') calcularConsumos();
        }

        // Adicionar contador √°gua
        function adicionarContadorAgua() {
            const input = document.getElementById('nova-agua');
            if (!input.value.trim()) return alert('Insira uma descri√ß√£o');
            const novoId = Math.max(0, ...dados.contadoresAgua.map(c => c.id)) + 1;
            dados.contadoresAgua.push({ id: novoId, descricao: input.value.trim() });
            if (guardarDados()) {
                input.value = '';
                renderizar();
                alert('Contador adicionado!');
            }
        }

        // Adicionar contador luz
        function adicionarContadorLuz() {
            const input = document.getElementById('nova-luz');
            if (!input.value.trim()) return alert('Insira uma descri√ß√£o');
            const novoId = Math.max(0, ...dados.contadoresLuz.map(c => c.id)) + 1;
            dados.contadoresLuz.push({ id: novoId, descricao: input.value.trim() });
            if (guardarDados()) {
                input.value = '';
                renderizar();
                alert('Contador adicionado!');
            }
        }

        // Remover contadores
        function removerContadorAgua(id) {
            if (dados.contadoresAgua.length <= 1) return alert('Deve existir pelo menos um contador');
            if (!confirm('Remover este contador?')) return;
            dados.contadoresAgua = dados.contadoresAgua.filter(c => c.id !== id);
            if (guardarDados()) {
                renderizar();
                alert('Contador removido!');
            }
        }

        function removerContadorLuz(id) {
            if (dados.contadoresLuz.length <= 1) return alert('Deve existir pelo menos um contador');
            if (!confirm('Remover este contador?')) return;
            dados.contadoresLuz = dados.contadoresLuz.filter(c => c.id !== id);
            if (guardarDados()) {
                renderizar();
                alert('Contador removido!');
            }
        }

        // Registar leitura
        function registarLeitura() {
            const dataLeitura = document.getElementById('data-leitura').value;
            const leituraAgua = dados.contadoresAgua.map(c => ({
                contadorId: c.id,
                descricao: c.descricao,
                valor: parseFloat(document.getElementById(`leitura-agua-${c.id}`).value || 0)
            }));
            const leituraLuz = dados.contadoresLuz.map(c => ({
                contadorId: c.id,
                descricao: c.descricao,
                valor: parseFloat(document.getElementById(`leitura-luz-${c.id}`).value || 0)
            }));

            if (leituraAgua.some(l => !l.valor) || leituraLuz.some(l => !l.valor)) {
                return alert('Preencha todas as leituras');
            }

            const novaLeitura = {
                id: Date.now(),
                data: dataLeitura,
                agua: leituraAgua,
                luz: leituraLuz
            };

            dados.leituras.push(novaLeitura);
            dados.leituras.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            if (guardarDados()) {
                alert('Leitura registada!');
                renderizar();
            }
        }

        // Registar fatura
        function registarFatura() {
            const mes = document.getElementById('mes-fatura').value;
            const agua = parseFloat(document.getElementById('valor-agua').value);
            const luz = parseFloat(document.getElementById('valor-luz').value);

            if (!agua || !luz) return alert('Preencha os valores');

            dados.faturas.push({ id: Date.now(), mes, agua, luz });
            dados.faturas.sort((a, b) => b.mes.localeCompare(a.mes));
            
            if (guardarDados()) {
                document.getElementById('valor-agua').value = '';
                document.getElementById('valor-luz').value = '';
                alert('Fatura registada!');
                renderizar();
            }
        }

        // Exportar
        function exportarDados() {
            const dataStr = JSON.stringify(dados, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Importar
        function importarDados(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const importado = JSON.parse(ev.target.result);
                    if (!confirm('Substituir dados atuais?')) return;
                    dados = importado;
                    if (guardarDados()) {
                        alert('Dados importados!');
                        renderizar();
                    }
                } catch (err) {
                    alert('Ficheiro inv√°lido');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        // Limpar tudo
        function limparTudo() {
            if (!confirm('ATEN√á√ÉO: Isto ir√° apagar TODOS os dados permanentemente. Tem certeza?')) return;
            if (!confirm('√öltima confirma√ß√£o: Apagar tudo mesmo?')) return;
            localStorage.removeItem('calculadora-agua-luz');
            dados = {
                contadoresAgua: [{ id: 1, descricao: 'Contador √Ågua 1' }],
                contadoresLuz: [{ id: 1, descricao: 'Contador Luz 1' }],
                leituras: [],
                faturas: []
            };
            guardarDados();
            renderizar();
            alert('Todos os dados foram apagados!');
        }

        // Renderizar inputs de leituras
        function renderizarInputsLeituras() {
            const inputsAgua = document.getElementById('inputs-agua');
            const inputsLuz = document.getElementById('inputs-luz');
            
            inputsAgua.innerHTML = dados.contadoresAgua.map(c => `
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">${c.descricao}</label>
                    <input type="number" step="0.001" id="leitura-agua-${c.id}" placeholder="0.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
            `).join('');

            inputsLuz.innerHTML = dados.contadoresLuz.map(c => `
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">${c.descricao}</label>
                    <input type="number" step="0.001" id="leitura-luz-${c.id}" placeholder="0.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
            `).join('');
        }

        // Calcular consumos
        function calcularConsumos() {
            const div = document.getElementById('resultados-calculos');
            
            if (dados.leituras.length < 2) {
                div.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center"><p class="text-yellow-800 font-semibold">Necessita de pelo menos 2 leituras</p></div>';
                return;
            }

            const leituraAtual = dados.leituras[0];
            const leituraAnterior = dados.leituras[1];
            const mes = leituraAtual.data.slice(0, 7);
            const fatura = dados.faturas.find(f => f.mes === mes);

            if (!fatura) {
                div.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center"><p class="text-yellow-800 font-semibold">Fatura n√£o encontrada para este per√≠odo</p></div>';
                return;
            }

            const consumosAgua = leituraAtual.agua.map(atual => {
                const anterior = leituraAnterior.agua.find(a => a.contadorId === atual.contadorId);
                return {
                    descricao: atual.descricao,
                    consumo: atual.valor - (anterior ? anterior.valor : 0)
                };
            });

            const consumosLuz = leituraAtual.luz.map(atual => {
                const anterior = leituraAnterior.luz.find(l => l.contadorId === atual.contadorId);
                return {
                    descricao: atual.descricao,
                    consumo: atual.valor - (anterior ? anterior.valor : 0)
                };
            });

            const totalAgua = consumosAgua.reduce((s, c) => s + c.consumo, 0);
            const totalLuz = consumosLuz.reduce((s, c) => s + c.consumo, 0);

            const custosAgua = consumosAgua.map(c => ({
                ...c,
                custo: (c.consumo / totalAgua) * fatura.agua
            }));

            const custosLuz = consumosLuz.map(c => ({
                ...c,
                custo: (c.consumo / totalLuz) * fatura.luz
            }));

            div.innerHTML = `
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6">
                    <p class="text-indigo-800 font-semibold text-sm md:text-base">Per√≠odo: ${new Date(leituraAnterior.data).toLocaleDateString('pt-PT')} a ${new Date(leituraAtual.data).toLocaleDateString('pt-PT')}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4 md:p-6">
                        <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">üíß √Ågua</h3>
                        <div class="space-y-3">
                            ${custosAgua.map(item => `
                                <div class="bg-white rounded-lg p-3">
                                    <p class="font-semibold text-gray-800 text-sm md:text-base">${item.descricao}</p>
                                    <p class="text-blue-600 font-bold text-lg md:text-xl">${item.consumo.toFixed(3)} m¬≥</p>
                                    <p class="text-gray-700 text-sm md:text-base">${item.custo.toFixed(2)} ‚Ç¨</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 md:p-6">
                        <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">‚ö° Luz</h3>
                        <div class="space-y-3">
                            ${custosLuz.map(item => `
                                <div class="bg-white rounded-lg p-3">
                                    <p class="font-semibold text-gray-800 text-sm md:text-base">${item.descricao}</p>
                                    <p class="text-yellow-600 font-bold text-lg md:text-xl">${item.consumo.toFixed(3)} kWh</p>
                                    <p class="text-gray-700 text-sm md:text-base">${item.custo.toFixed(2)} ‚Ç¨</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-4 md:p-6">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Totais Gerais</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p class="text-xs md:text-sm text-gray-600">√Ågua Total</p>
                            <p class="text-lg md:text-xl font-bold text-blue-600">${totalAgua.toFixed(3)} m¬≥</p>
                            <p class="text-base md:text-lg text-gray-700">${fatura.agua.toFixed(2)} ‚Ç¨</p>
                        </div>
                        <div>
                            <p class="text-xs md:text-sm text-gray-600">Luz Total</p>
                            <p class="text-lg md:text-xl font-bold text-yellow-600">${totalLuz.toFixed(3)} kWh</p>
                            <p class="text-base md:text-lg text-gray-700">${fatura.luz.toFixed(2)} ‚Ç¨</p>
                        </div>
                        <div>
                            <p class="text-xs md:text-sm text-gray-600">Custo Total</p>
                            <p class="text-xl md:text-2xl font-bold text-indigo-600">${(fatura.agua + fatura.luz).toFixed(2)} ‚Ç¨</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renderizar tudo
        function renderizar() {
            // Contadores √Ågua
            document.getElementById('lista-agua').innerHTML = dados.contadoresAgua.map(c => `
                <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4">
                    <span class="font-semibold text-gray-800 text-sm md:text-base">${c.descricao}</span>
                    <button onclick="removerContadorAgua(${c.id})" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700">üóëÔ∏è</button>
                </div>
            `).join('');

            // Contadores Luz
            document.getElementById('lista-luz').innerHTML = dados.contadoresLuz.map(c => `
                <div class="flex items-center justify-between bg-yellow-50 border border-yellow-200 rounded-lg p-3 md:p-4">
                    <span class="font-semibold text-gray-800 text-sm md:text-base">${c.descricao}</span>
                    <button onclick="removerContadorLuz(${c.id})" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700">üóëÔ∏è</button>
                </div>
            `).join('');

            // Hist√≥rico Leituras
            if (dados.leituras.length > 0) {
                document.getElementById('historico-leituras').innerHTML = `
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Hist√≥rico</h3>
                    <div class="space-y-3">
                        ${dados.leituras.map(l => `
                            <div class="bg-white border border-gray-200 rounded-lg p-3 md:p-4">
                                <p class="font-bold text-gray-800 mb-3 text-sm md:text-base">${new Date(l.data).toLocaleDateString('pt-PT')}</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs md:text-sm">
                                    <div>
                                        <p class="font-semibold text-blue-600 mb-2">√Ågua:</p>
                                        ${l.agua.map(a => `<p class="text-gray-600">${a.descricao}: ${a.valor.toFixed(3)} m¬≥</p>`).join('')}
                                    </div>
                                    <div>
                                        <p class="font-semibold text-yellow-600 mb-2">Luz:</p>
                                        ${l.luz.map(lz => `<p class="text-gray-600">${lz.descricao}: ${lz.valor.toFixed(3)} kWh</p>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Hist√≥rico Faturas
            if (dados.faturas.length > 0) {
                document.getElementById('historico-faturas').innerHTML = `
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Hist√≥rico</h3>
                    <div class="space-y-3 max-w-2xl mx-auto">
                        ${dados.faturas.map(f => `
                            <div class="bg-white border border-gray-200 rounded-lg p-3 md:p-4">
                                <p class="font-bold text-gray-800 mb-2 text-sm md:text-base">${new Date(f.mes + '-01').toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' })}</p>
                                <div class="grid grid-cols-2 gap-4 text-xs md:text-sm">
                                    <p class="text-gray-600">√Ågua: ${f.agua.toFixed(2)} ‚Ç¨</p>
                                    <p class="text-gray-600">Luz: ${f.luz.toFixed(2)} ‚Ç¨</p>
                                </div>
                                <p class="font-bold text-indigo-600 mt-2 text-sm md:text-base">Total: ${(f.agua + f.luz).toFixed(2)} ‚Ç¨</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>