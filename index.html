<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de √Ågua e Luz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Calculadora de √Ågua e Luz</h1>
                <p class="text-sm md:text-base text-gray-600 mb-4">
                    <span id="status-conexao" class="font-semibold">üîÑ A conectar...</span>
                </p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="sincronizar()" class="flex-1 md:flex-none bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700">
                        üîÑ Sincronizar
                    </button>
                    <button onclick="exportarDados()" class="flex-1 md:flex-none bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-green-700">
                        ‚¨áÔ∏è Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Aviso -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <p class="text-blue-800 text-sm">
                <strong>‚ÑπÔ∏è Sistema:</strong> A Casa Principal consome a diferen√ßa entre o contador geral e a soma dos terrenos. Todos pagam proporcionalmente.
            </p>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-lg mb-6">
            <div class="grid grid-cols-2 md:flex border-b overflow-x-auto">
                <button onclick="mudarTab('principal')" id="tab-principal" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold bg-indigo-600 text-white whitespace-nowrap">
                    üè† Casa Principal
                </button>
                <button onclick="mudarTab('terrenos')" id="tab-terrenos" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50 whitespace-nowrap">
                    üèòÔ∏è Terrenos
                </button>
                <button onclick="mudarTab('leituras')" id="tab-leituras" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50 whitespace-nowrap">
                    üìÖ Leituras
                </button>
                <button onclick="mudarTab('faturas')" id="tab-faturas" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50 whitespace-nowrap">
                    üí∂ Faturas
                </button>
                <button onclick="mudarTab('calculos')" id="tab-calculos" class="py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50 whitespace-nowrap">
                    üßÆ Calcular
                </button>
            </div>

            <div class="p-4 md:p-6">
                <!-- Tab Casa Principal -->
                <div id="content-principal">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">üè† Contador Principal da Casa</h2>
                    <p class="text-sm text-gray-600 mb-6">Este √© o contador geral que recebe a fatura da companhia. O consumo da casa ser√° calculado automaticamente.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-300">
                            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                üíß Contador √Ågua Principal
                            </h3>
                            <div id="contador-principal-agua"></div>
                        </div>
                        
                        <div class="bg-yellow-50 rounded-lg p-4 border-2 border-yellow-300">
                            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                ‚ö° Contador Luz Principal
                            </h3>
                            <div id="contador-principal-luz"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab Terrenos -->
                <div id="content-terrenos" class="hidden">
                    <div class="space-y-8">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">üíß Contadores de √Ågua dos Terrenos</h2>
                            <div id="lista-agua" class="space-y-3 mb-4"></div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="nova-agua" placeholder="Nome do terreno" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                                <button onclick="adicionarContadorAgua()" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-2 rounded-lg text-sm md:text-base font-semibold hover:bg-blue-700">
                                    ‚ûï Adicionar
                                </button>
                            </div>
                        </div>

                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">‚ö° Contadores de Luz dos Terrenos</h2>
                            <div id="lista-luz" class="space-y-3 mb-4"></div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="nova-luz" placeholder="Nome do terreno" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                                <button onclick="adicionarContadorLuz()" class="w-full sm:w-auto bg-yellow-600 text-white px-6 py-2 rounded-lg text-sm md:text-base font-semibold hover:bg-yellow-700">
                                    ‚ûï Adicionar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Leituras -->
                <div id="content-leituras" class="hidden">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">Registar Leitura Mensal</h2>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Data da Leitura</label>
                        <input type="date" id="data-leitura" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <!-- Contador Principal -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6 border-2 border-gray-300">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üè† Casa Principal (Contador Geral)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2" id="label-principal-agua">√Ågua (m¬≥)</label>
                                <input type="number" step="0.001" id="leitura-principal-agua" placeholder="0.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2" id="label-principal-luz">Luz (kWh)</label>
                                <input type="number" step="0.001" id="leitura-principal-luz" placeholder="0.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Terrenos -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">üíß √Ågua Terrenos (m¬≥)</h3>
                            <div id="inputs-agua" class="space-y-3"></div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">‚ö° Luz Terrenos (kWh)</h3>
                            <div id="inputs-luz" class="space-y-3"></div>
                        </div>
                    </div>
                    <button onclick="registarLeitura()" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">
                        ‚ûï Registar Leitura
                    </button>
                    <div id="historico-leituras" class="mt-8"></div>
                </div>

                <!-- Tab Faturas -->
                <div id="content-faturas" class="hidden">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">Registar Fatura Mensal</h2>
                    <div class="max-w-2xl mx-auto">
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">M√™s de Refer√™ncia</label>
                            <input type="month" id="mes-fatura" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üíß Valor Total √Ågua (‚Ç¨)</label>
                            <input type="number" step="0.01" id="valor-agua" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">‚ö° Valor Total Luz (‚Ç¨)</label>
                            <input type="number" step="0.01" id="valor-luz" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <button onclick="registarFatura()" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">
                            ‚ûï Registar Fatura
                        </button>
                    </div>
                    <div id="historico-faturas" class="mt-8"></div>
                </div>

                <!-- Tab C√°lculos -->
                <div id="content-calculos" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">C√°lculo de Consumos e Custos</h2>
                        <button onclick="exportarCalculos()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 flex items-center gap-2">
                            üìÑ Exportar C√°lculos
                        </button>
                    </div>
                    <div id="resultados-calculos"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAzHEpMGVT3HtsSSgdHVcNANMdjiQMeO-g",
            authDomain: "calculadora-agua-luz.firebaseapp.com",
            projectId: "calculadora-agua-luz",
            storageBucket: "calculadora-agua-luz.firebasestorage.app",
            messagingSenderId: "931167809034",
            appId: "1:931167809034:web:d3ace9cbe99b209fc7b9f3"
        };

        let db = null;
        let firebaseConfigured = false;
        let editandoContadorAgua = null;
        let editandoContadorLuz = null;
        let editandoLeitura = null;
        let editandoFatura = null;
        let dados = {
            contadorPrincipalAgua: { id: 'principal-agua', descricao: 'Contador Principal √Ågua' },
            contadorPrincipalLuz: { id: 'principal-luz', descricao: 'Contador Principal Luz' },
            contadoresAgua: [],
            contadoresLuz: [],
            leituras: [],
            faturas: []
        };

        document.addEventListener('DOMContentLoaded', () => {
            inicializarFirebase();
            document.getElementById('data-leitura').valueAsDate = new Date();
            const hoje = new Date();
            document.getElementById('mes-fatura').value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
        });

        function inicializarFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                }
                db = firebase.firestore();
                firebaseConfigured = true;
                atualizarStatus('üü¢ Conectado');
                carregarDadosFirebase();
            } catch (e) {
                console.error('Erro Firebase:', e);
                atualizarStatus('üî¥ Erro: ' + e.message);
                firebaseConfigured = false;
                renderizar();
            }
        }

        function atualizarStatus(texto) {
            document.getElementById('status-conexao').textContent = texto;
        }

        async function carregarDadosFirebase() {
            if (!firebaseConfigured) return;
            
            try {
                const docRef = await db.collection('dados').doc('principal').get();
                if (docRef.exists) {
                    const data = docRef.data();
                    dados.contadorPrincipalAgua = data.contadorPrincipalAgua || dados.contadorPrincipalAgua;
                    dados.contadorPrincipalLuz = data.contadorPrincipalLuz || dados.contadorPrincipalLuz;
                    dados.contadoresAgua = data.contadoresAgua || [];
                    dados.contadoresLuz = data.contadoresLuz || [];
                    dados.leituras = data.leituras || [];
                    dados.faturas = data.faturas || [];
                }
                renderizar();
            } catch (e) {
                console.error('Erro ao carregar:', e);
                atualizarStatus('üî¥ Erro ao carregar: ' + e.message);
            }
        }

        async function guardarFirebase() {
            if (!firebaseConfigured) {
                alert('Firebase n√£o conectado');
                return false;
            }

            try {
                await db.collection('dados').doc('principal').set(dados);
                return true;
            } catch (e) {
                console.error('Erro ao guardar:', e);
                alert('Erro ao guardar: ' + e.message);
                return false;
            }
        }

        async function sincronizar() {
            if (!firebaseConfigured) return alert('Firebase n√£o conectado');
            atualizarStatus('üîÑ Sincronizando...');
            await carregarDadosFirebase();
            atualizarStatus('üü¢ Conectado');
        }

        function mudarTab(tab) {
            ['principal', 'terrenos', 'leituras', 'faturas', 'calculos'].forEach(t => {
                const tabEl = document.getElementById(`tab-${t}`);
                const contentEl = document.getElementById(`content-${t}`);
                if (tabEl && contentEl) {
                    tabEl.className = 'py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold text-gray-600 hover:bg-gray-50 whitespace-nowrap';
                    contentEl.classList.add('hidden');
                }
            });
            
            const activeTab = document.getElementById(`tab-${tab}`);
            const activeContent = document.getElementById(`content-${tab}`);
            if (activeTab && activeContent) {
                activeTab.className = 'py-3 px-2 md:flex-1 md:py-4 md:px-4 text-sm md:text-base font-semibold bg-indigo-600 text-white whitespace-nowrap';
                activeContent.classList.remove('hidden');
            }
            
            if (tab === 'leituras') renderizarInputsLeituras();
            if (tab === 'calculos') calcularConsumos();
        }

        async function editarContadorPrincipal(tipo) {
            const novaDescricao = prompt(
                `Nova descri√ß√£o para o contador ${tipo === 'agua' ? 'de √°gua' : 'de luz'}:`,
                tipo === 'agua' ? dados.contadorPrincipalAgua.descricao : dados.contadorPrincipalLuz.descricao
            );
            
            if (novaDescricao && novaDescricao.trim()) {
                if (tipo === 'agua') {
                    dados.contadorPrincipalAgua.descricao = novaDescricao.trim();
                } else {
                    dados.contadorPrincipalLuz.descricao = novaDescricao.trim();
                }
                if (await guardarFirebase()) renderizar();
            }
        }

        async function adicionarContadorAgua() {
            const input = document.getElementById('nova-agua');
            if (!input.value.trim()) return alert('Insira um nome');
            const novoId = Date.now();
            dados.contadoresAgua.push({ id: novoId, descricao: input.value.trim() });
            if (await guardarFirebase()) {
                input.value = '';
                renderizar();
            }
        }

        async function adicionarContadorLuz() {
            const input = document.getElementById('nova-luz');
            if (!input.value.trim()) return alert('Insira um nome');
            const novoId = Date.now();
            dados.contadoresLuz.push({ id: novoId, descricao: input.value.trim() });
            if (await guardarFirebase()) {
                input.value = '';
                renderizar();
            }
        }

        function editarContadorAgua(id) {
            editandoContadorAgua = id;
            renderizar();
        }

        function editarContadorLuz(id) {
            editandoContadorLuz = id;
            renderizar();
        }

        async function salvarEdicaoContadorAgua(id) {
            const novaDescricao = document.getElementById(`edit-agua-${id}`).value.trim();
            if (!novaDescricao) return alert('Insira uma descri√ß√£o');
            dados.contadoresAgua = dados.contadoresAgua.map(c => 
                c.id === id ? { ...c, descricao: novaDescricao } : c
            );
            if (await guardarFirebase()) {
                editandoContadorAgua = null;
                renderizar();
            }
        }

        async function salvarEdicaoContadorLuz(id) {
            const novaDescricao = document.getElementById(`edit-luz-${id}`).value.trim();
            if (!novaDescricao) return alert('Insira uma descri√ß√£o');
            dados.contadoresLuz = dados.contadoresLuz.map(c => 
                c.id === id ? { ...c, descricao: novaDescricao } : c
            );
            if (await guardarFirebase()) {
                editandoContadorLuz = null;
                renderizar();
            }
        }

        function cancelarEdicaoAgua() {
            editandoContadorAgua = null;
            renderizar();
        }

        function cancelarEdicaoLuz() {
            editandoContadorLuz = null;
            renderizar();
        }

        async function removerContadorAgua(id) {
            if (!confirm('Remover este contador?')) return;
            dados.contadoresAgua = dados.contadoresAgua.filter(c => c.id !== id);
            if (await guardarFirebase()) renderizar();
        }

        async function removerContadorLuz(id) {
            if (!confirm('Remover este contador?')) return;
            dados.contadoresLuz = dados.contadoresLuz.filter(c => c.id !== id);
            if (await guardarFirebase()) renderizar();
        }

        async function registarLeitura() {
            const dataLeitura = document.getElementById('data-leitura').value;
            const principalAgua = parseInt(document.getElementById('leitura-principal-agua').value || 0);
            const principalLuz = parseInt(document.getElementById('leitura-principal-luz').value || 0);

            if (!principalAgua || !principalLuz) {
                return alert('Preencha as leituras do contador principal');
            }

            const leituraAgua = dados.contadoresAgua.map(c => ({
                contadorId: c.id,
                descricao: c.descricao,
                valor: parseInt(document.getElementById(`leitura-agua-${c.id}`).value || 0)
            }));
            
            const leituraLuz = dados.contadoresLuz.map(c => ({
                contadorId: c.id,
                descricao: c.descricao,
                valor: parseInt(document.getElementById(`leitura-luz-${c.id}`).value || 0)
            }));

            if (leituraAgua.some(l => !l.valor) || leituraLuz.some(l => !l.valor)) {
                return alert('Preencha todas as leituras dos terrenos');
            }

            dados.leituras.push({
                id: Date.now(),
                data: dataLeitura,
                principalAgua,
                principalLuz,
                agua: leituraAgua,
                luz: leituraLuz
            });
            dados.leituras.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            if (await guardarFirebase()) {
                alert('Leitura registada!');
                document.getElementById('leitura-principal-agua').value = '';
                document.getElementById('leitura-principal-luz').value = '';
                renderizar();
            }
        }

        function editarLeitura(id) {
            const leitura = dados.leituras.find(l => l.id === id);
            if (!leitura) return;
            editandoLeitura = JSON.parse(JSON.stringify(leitura));
            renderizar();
        }

        async function salvarEdicaoLeitura() {
            if (!editandoLeitura) return;
            dados.leituras = dados.leituras.map(l => 
                l.id === editandoLeitura.id ? editandoLeitura : l
            );
            dados.leituras.sort((a, b) => new Date(b.data) - new Date(a.data));
            if (await guardarFirebase()) {
                editandoLeitura = null;
                renderizar();
            }
        }

        function cancelarEdicaoLeitura() {
            editandoLeitura = null;
            renderizar();
        }

        async function eliminarLeitura(id) {
            if (!confirm('Eliminar esta leitura?')) return;
            dados.leituras = dados.leituras.filter(l => l.id !== id);
            if (await guardarFirebase()) renderizar();
        }

        async function registarFatura() {
            const mes = document.getElementById('mes-fatura').value;
            const agua = parseFloat(document.getElementById('valor-agua').value);
            const luz = parseFloat(document.getElementById('valor-luz').value);

            if (!agua || !luz) return alert('Preencha os valores');

            dados.faturas.push({ id: Date.now(), mes, agua, luz });
            dados.faturas.sort((a, b) => b.mes.localeCompare(a.mes));
            
            if (await guardarFirebase()) {
                document.getElementById('valor-agua').value = '';
                document.getElementById('valor-luz').value = '';
                alert('Fatura registada!');
                renderizar();
            }
        }

        function editarFatura(id) {
            const fatura = dados.faturas.find(f => f.id === id);
            if (!fatura) return;
            editandoFatura = JSON.parse(JSON.stringify(fatura));
            renderizar();
        }

        async function salvarEdicaoFatura() {
            if (!editandoFatura) return;
            dados.faturas = dados.faturas.map(f => 
                f.id === editandoFatura.id ? editandoFatura : f
            );
            dados.faturas.sort((a, b) => b.mes.localeCompare(a.mes));
            if (await guardarFirebase()) {
                editandoFatura = null;
                renderizar();
            }
        }

        function cancelarEdicaoFatura() {
            editandoFatura = null;
            renderizar();
        }

        async function eliminarFatura(id) {
            if (!confirm('Eliminar esta fatura?')) return;
            dados.faturas = dados.faturas.filter(f => f.id !== id);
            if (await guardarFirebase()) renderizar();
        }

        function exportarDados() {
            const dataStr = JSON.stringify(dados, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportarCalculos() {
            if (dados.leituras.length < 2) {
                return alert('Necessita de pelo menos 2 leituras para exportar c√°lculos');
            }

            const leiturasOrdenadas = [...dados.leituras].sort((a, b) => new Date(a.data) - new Date(b.data));
            let relatorio = '='.repeat(60) + '\n';
            relatorio += '         RELATORIO DE CONSUMOS E CUSTOS\n';
            relatorio += '='.repeat(60) + '\n\n';

            dados.faturas.forEach(fatura => {
                for (let i = 1; i < leiturasOrdenadas.length; i++) {
                    const leituraAnterior = leiturasOrdenadas[i - 1];
                    const leituraAtual = leiturasOrdenadas[i];
                    
                    const dataAnterior = new Date(leituraAnterior.data);
                    const dataAtual = new Date(leituraAtual.data);
                    const dataFatura = new Date(fatura.mes + '-01');
                    
                    if (dataFatura >= dataAnterior && dataFatura <= dataAtual) {
                        const consumoPrincipalAgua = leituraAtual.principalAgua - leituraAnterior.principalAgua;
                        const consumoPrincipalLuz = leituraAtual.principalLuz - leituraAnterior.principalLuz;

                        const consumosAgua = leituraAtual.agua.map(atual => {
                            const anterior = leituraAnterior.agua.find(a => a.contadorId === atual.contadorId);
                            return { descricao: atual.descricao, consumo: atual.valor - (anterior ? anterior.valor : 0) };
                        });

                        const consumosLuz = leituraAtual.luz.map(atual => {
                            const anterior = leituraAnterior.luz.find(l => l.contadorId === atual.contadorId);
                            return { descricao: atual.descricao, consumo: atual.valor - (anterior ? anterior.valor : 0) };
                        });

                        const somaAgua = consumosAgua.reduce((s, c) => s + c.consumo, 0);
                        const somaLuz = consumosLuz.reduce((s, c) => s + c.consumo, 0);
                        const consumoCasaAgua = consumoPrincipalAgua - somaAgua;
                        const consumoCasaLuz = consumoPrincipalLuz - somaLuz;

                        const custoCasaAgua = (consumoCasaAgua / consumoPrincipalAgua) * fatura.agua;
                        const custoCasaLuz = (consumoCasaLuz / consumoPrincipalLuz) * fatura.luz;

                        relatorio += `MES: ${new Date(fatura.mes + '-01').toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' })}\n`;
                        relatorio += `Periodo: ${new Date(leituraAnterior.data).toLocaleDateString('pt-PT')} a ${new Date(leituraAtual.data).toLocaleDateString('pt-PT')}\n`;
                        relatorio += '-'.repeat(60) + '\n\n';

                        relatorio += 'CASA PRINCIPAL\n';
                        relatorio += `   Agua: ${consumoCasaAgua} (${consumoPrincipalAgua} total - ${somaAgua} terrenos)\n`;
                        relatorio += `   Custo Agua: ‚Ç¨${custoCasaAgua.toFixed(2)}\n`;
                        relatorio += `   Luz: ${consumoCasaLuz} (${consumoPrincipalLuz} total - ${somaLuz} terrenos)\n`;
                        relatorio += `   Custo Luz: ‚Ç¨${custoCasaLuz.toFixed(2)}\n`;
                        relatorio += `   TOTAL A PAGAR: ‚Ç¨${(custoCasaAgua + custoCasaLuz).toFixed(2)}\n\n`;

                        relatorio += 'TERRENOS\n';
                        consumosAgua.forEach((itemAgua, idx) => {
                            const itemLuz = consumosLuz[idx];
                            const custoAgua = (itemAgua.consumo / consumoPrincipalAgua) * fatura.agua;
                            const custoLuz = (itemLuz.consumo / consumoPrincipalLuz) * fatura.luz;
                            relatorio += `   ${itemAgua.descricao}:\n`;
                            relatorio += `      Agua: ${itemAgua.consumo} -> ‚Ç¨${custoAgua.toFixed(2)}\n`;
                            relatorio += `      Luz: ${itemLuz.consumo} -> ‚Ç¨${custoLuz.toFixed(2)}\n`;
                            relatorio += `      TOTAL: ‚Ç¨${(custoAgua + custoLuz).toFixed(2)}\n\n`;
                        });

                        relatorio += 'VERIFICACAO\n';
                        relatorio += `   Fatura Total: ‚Ç¨${(fatura.agua + fatura.luz).toFixed(2)}\n\n`;
                        relatorio += '='.repeat(60) + '\n\n';
                        break;
                    }
                }
            });

            const blob = new Blob([relatorio], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio-calculos-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function renderizarInputsLeituras() {
            document.getElementById('label-principal-agua').textContent = dados.contadorPrincipalAgua.descricao;
            document.getElementById('label-principal-luz').textContent = dados.contadorPrincipalLuz.descricao;

            document.getElementById('inputs-agua').innerHTML = dados.contadoresAgua.map(c => `
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">${c.descricao}</label>
                    <input type="number" step="1" id="leitura-agua-${c.id}" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
            `).join('');

            document.getElementById('inputs-luz').innerHTML = dados.contadoresLuz.map(c => `
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">${c.descricao}</label>
                    <input type="number" step="1" id="leitura-luz-${c.id}" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
            `).join('');
        }

        function calcularConsumos() {
            const div = document.getElementById('resultados-calculos');
            
            if (dados.leituras.length < 2) {
                div.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center"><p class="text-yellow-800 font-semibold">Necessita de pelo menos 2 leituras</p></div>';
                return;
            }

            if (dados.faturas.length === 0) {
                div.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center"><p class="text-yellow-800 font-semibold">Necessita de pelo menos 1 fatura registada</p></div>';
                return;
            }

            const leiturasOrdenadas = [...dados.leituras].sort((a, b) => new Date(a.data) - new Date(b.data));
            const faturasDisponiveis = [];
            
            dados.faturas.forEach(fatura => {
                for (let i = 1; i < leiturasOrdenadas.length; i++) {
                    const leituraAnterior = leiturasOrdenadas[i - 1];
                    const leituraAtual = leiturasOrdenadas[i];
                    
                    const dataAnterior = new Date(leituraAnterior.data);
                    const dataAtual = new Date(leituraAtual.data);
                    const dataFatura = new Date(fatura.mes + '-01');
                    
                    if (dataFatura >= dataAnterior && dataFatura <= dataAtual) {
                        faturasDisponiveis.push({
                            ...fatura,
                            leituraAtualIdx: i,
                            leituraAnteriorIdx: i - 1
                        });
                        break;
                    }
                }
            });

            if (faturasDisponiveis.length === 0) {
                div.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                        <p class="text-yellow-800 font-semibold mb-4">‚ö†Ô∏è N√£o foi poss√≠vel associar faturas √†s leituras</p>
                        <div class="text-sm space-y-2 text-gray-700">
                            <p><strong>Faturas registadas:</strong></p>
                            ${dados.faturas.map(f => `<p>‚Ä¢ ${new Date(f.mes + '-01').toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' })}</p>`).join('')}
                            <p class="mt-4"><strong>Leituras registadas:</strong></p>
                            ${leiturasOrdenadas.map(l => `<p>‚Ä¢ ${new Date(l.data).toLocaleDateString('pt-PT')}</p>`).join('')}
                            <p class="mt-4 text-xs text-gray-600">üí° Dica: Certifique-se que tem leituras antes e durante o m√™s da fatura.</p>
                        </div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Selecione o m√™s para visualizar:</label>
                    <select id="select-mes-calculo" onchange="mostrarCalculoMes()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        ${faturasDisponiveis.map(f => `
                            <option value="${f.mes}">${new Date(f.mes + '-01').toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' })}</option>
                        `).join('')}
                    </select>
                </div>
                <div id="calculo-detalhado"></div>
            `;

            div.innerHTML = html;
            mostrarCalculoMes();
        }

        function mostrarCalculoMes() {
            const selectElement = document.getElementById('select-mes-calculo');
            if (!selectElement) return;
            
            const mesSelecionado = selectElement.value;
            const fatura = dados.faturas.find(f => f.mes === mesSelecionado);
            if (!fatura) return;

            const leiturasOrdenadas = [...dados.leituras].sort((a, b) => new Date(a.data) - new Date(b.data));
            let leituraAtual = null;
            let leituraAnterior = null;

            for (let i = 1; i < leiturasOrdenadas.length; i++) {
                const anterior = leiturasOrdenadas[i - 1];
                const atual = leiturasOrdenadas[i];
                
                const dataAnterior = new Date(anterior.data);
                const dataAtual = new Date(atual.data);
                const dataFatura = new Date(mesSelecionado + '-01');
                
                if (dataFatura >= dataAnterior && dataFatura <= dataAtual) {
                    leituraAnterior = anterior;
                    leituraAtual = atual;
                    break;
                }
            }

            if (!leituraAtual || !leituraAnterior) {
                document.getElementById('calculo-detalhado').innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center"><p class="text-yellow-800 font-semibold">Sem leituras correspondentes para este m√™s</p></div>';
                return;
            }

            const consumoPrincipalAgua = leituraAtual.principalAgua - leituraAnterior.principalAgua;
            const consumoPrincipalLuz = leituraAtual.principalLuz - leituraAnterior.principalLuz;

            const consumosAgua = leituraAtual.agua.map(atual => {
                const anterior = leituraAnterior.agua.find(a => a.contadorId === atual.contadorId);
                return {
                    descricao: atual.descricao,
                    consumo: atual.valor - (anterior ? anterior.valor : 0)
                };
            });

            const consumosLuz = leituraAtual.luz.map(atual => {
                const anterior = leituraAnterior.luz.find(l => l.contadorId === atual.contadorId);
                return {
                    descricao: atual.descricao,
                    consumo: atual.valor - (anterior ? anterior.valor : 0)
                };
            });

            const somaAgua = consumosAgua.reduce((s, c) => s + c.consumo, 0);
            const somaLuz = consumosLuz.reduce((s, c) => s + c.consumo, 0);

            const consumoCasaAgua = consumoPrincipalAgua - somaAgua;
            const consumoCasaLuz = consumoPrincipalLuz - somaLuz;

            if (consumoCasaAgua < 0 || consumoCasaLuz < 0) {
                document.getElementById('calculo-detalhado').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <p class="text-red-800 font-semibold mb-2">‚ö†Ô∏è ERRO: Soma dos terrenos √© maior que o contador principal!</p>
                        <p class="text-red-700 text-sm">Verifique as leituras.</p>
                    </div>
                `;
                return;
            }

            const custoCasaAgua = (consumoCasaAgua / consumoPrincipalAgua) * fatura.agua;
            const custoCasaLuz = (consumoCasaLuz / consumoPrincipalLuz) * fatura.luz;
            const custoCasaTotal = custoCasaAgua + custoCasaLuz;

            const custosAgua = consumosAgua.map(c => ({
                ...c,
                custo: (c.consumo / consumoPrincipalAgua) * fatura.agua
            }));

            const custosLuz = consumosLuz.map(c => ({
                ...c,
                custo: (c.consumo / consumoPrincipalLuz) * fatura.luz
            }));

            const totalPagoTerrenos = custosAgua.reduce((s, c) => s + c.custo, 0) + custosLuz.reduce((s, c) => s + c.custo, 0);
            const totalGeral = totalPagoTerrenos + custoCasaTotal;

            document.getElementById('calculo-detalhado').innerHTML = `
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6">
                    <p class="text-indigo-800 font-semibold text-sm md:text-base">
                        Per√≠odo: ${new Date(leituraAnterior.data).toLocaleDateString('pt-PT')} a ${new Date(leituraAtual.data).toLocaleDateString('pt-PT')}
                    </p>
                </div>

                <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-300 rounded-lg p-4 md:p-6 mb-6">
                    <h3 class="text-xl md:text-2xl font-bold text-purple-800 mb-4">üè† CASA PRINCIPAL</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-white rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">üíß</span>
                                <span class="font-semibold text-gray-700">√Ågua</span>
                            </div>
                            <p class="text-xl md:text-2xl font-bold text-blue-600">${consumoCasaAgua}</p>
                            <p class="text-sm text-gray-500 mt-1">(${consumoPrincipalAgua} total - ${somaAgua} terrenos)</p>
                            <p class="text-lg text-gray-700 mt-2">${custoCasaAgua.toFixed(2)} ‚Ç¨</p>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">‚ö°</span>
                                <span class="font-semibold text-gray-700">Luz</span>
                            </div>
                            <p class="text-xl md:text-2xl font-bold text-yellow-600">${consumoCasaLuz}</p>
                            <p class="text-sm text-gray-500 mt-1">(${consumoPrincipalLuz} total - ${somaLuz} terrenos)</p>
                            <p class="text-lg text-gray-700 mt-2">${custoCasaLuz.toFixed(2)} ‚Ç¨</p>
                        </div>
                    </div>
                    <div class="bg-purple-100 rounded-lg p-4 border-2 border-purple-300">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-purple-800">CASA A PAGAR:</span>
                            <span class="text-2xl md:text-3xl font-bold text-purple-600">${custoCasaTotal.toFixed(2)} ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">üèòÔ∏è TERRENOS</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    ${custosAgua.map((itemAgua, idx) => {
                        const itemLuz = custosLuz[idx];
                        const totalTerreno = itemAgua.custo + itemLuz.custo;
                        return `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                <h4 class="text-lg font-bold text-gray-800 mb-3">${itemAgua.descricao}</h4>
                                <div class="space-y-2 mb-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">üíß √Ågua:</span>
                                        <span class="font-semibold">${itemAgua.consumo} ‚Üí ${itemAgua.custo.toFixed(2)} ‚Ç¨</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">‚ö° Luz:</span>
                                        <span class="font-semibold">${itemLuz.consumo} ‚Üí ${itemLuz.custo.toFixed(2)} ‚Ç¨</span>
                                    </div>
                                </div>
                                <div class="pt-3 border-t border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-gray-700">A PAGAR:</span>
                                        <span class="text-xl font-bold text-indigo-600">${totalTerreno.toFixed(2)} ‚Ç¨</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="bg-gray-100 border-2 border-gray-400 rounded-lg p-4 md:p-6">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">üìä VERIFICA√á√ÉO E TOTAIS</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-1">Valor Fatura</p>
                            <p class="text-xl md:text-2xl font-bold text-gray-800">${(fatura.agua + fatura.luz).toFixed(2)} ‚Ç¨</p>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-1">Total Calculado</p>
                            <p class="text-xl md:text-2xl font-bold ${Math.abs(totalGeral - (fatura.agua + fatura.luz)) < 0.01 ? 'text-green-600' : 'text-red-600'}">
                                ${totalGeral.toFixed(2)} ‚Ç¨
                            </p>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-1">Diferen√ßa</p>
                            <p class="text-xl md:text-2xl font-bold ${Math.abs(totalGeral - (fatura.agua + fatura.luz)) < 0.01 ? 'text-green-600' : 'text-red-600'}">
                                ${(totalGeral - (fatura.agua + fatura.luz)).toFixed(2)} ‚Ç¨
                            </p>
                        </div>
                    </div>
                    ${Math.abs(totalGeral - (fatura.agua + fatura.luz)) < 0.01 ? 
                        '<p class="text-green-700 font-semibold mt-4 text-center">‚úî Valores conferem!</p>' : 
                        '<p class="text-red-700 font-semibold mt-4 text-center">‚ö†Ô∏è Diferen√ßa detectada!</p>'
                    }
                </div>
            `;
        }

        function renderizar() {
            document.getElementById('contador-principal-agua').innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-gray-800">${dados.contadorPrincipalAgua.descricao}</p>
                        <p class="text-sm text-gray-600">Contador geral da companhia</p>
                    </div>
                    <button onclick="editarContadorPrincipal('agua')" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">
                        ‚úèÔ∏è
                    </button>
                </div>
            `;

            document.getElementById('contador-principal-luz').innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-gray-800">${dados.contadorPrincipalLuz.descricao}</p>
                        <p class="text-sm text-gray-600">Contador geral da companhia</p>
                    </div>
                    <button onclick="editarContadorPrincipal('luz')" class="bg-yellow-600 text-white p-2 rounded-lg hover:bg-yellow-700">
                        ‚úèÔ∏è
                    </button>
                </div>
            `;

            document.getElementById('lista-agua').innerHTML = dados.contadoresAgua.map(c => {
                if (editandoContadorAgua === c.id) {
                    return `
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4">
                            <input type="text" id="edit-agua-${c.id}" value="${c.descricao}" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                            <div class="flex gap-2">
                                <button onclick="salvarEdicaoContadorAgua(${c.id})" class="flex-1 sm:flex-none bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">‚úì Guardar</button>
                                <button onclick="cancelarEdicaoAgua()" class="flex-1 sm:flex-none bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 text-sm">‚úï Cancelar</button>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4">
                        <span class="font-semibold text-gray-800 text-sm md:text-base">${c.descricao}</span>
                        <div class="flex gap-2">
                            <button onclick="editarContadorAgua(${c.id})" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 text-xs md:text-sm">‚úèÔ∏è</button>
                            <button onclick="removerContadorAgua(${c.id})" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 text-xs md:text-sm">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('lista-luz').innerHTML = dados.contadoresLuz.map(c => {
                if (editandoContadorLuz === c.id) {
                    return `
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3 md:p-4">
                            <input type="text" id="edit-luz-${c.id}" value="${c.descricao}" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                            <div class="flex gap-2">
                                <button onclick="salvarEdicaoContadorLuz(${c.id})" class="flex-1 sm:flex-none bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">‚úì Guardar</button>
                                <button onclick="cancelarEdicaoLuz()" class="flex-1 sm:flex-none bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 text-sm">‚úï Cancelar</button>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div class="flex items-center justify-between bg-yellow-50 border border-yellow-200 rounded-lg p-3 md:p-4">
                        <span class="font-semibold text-gray-800 text-sm md:text-base">${c.descricao}</span>
                        <div class="flex gap-2">
                            <button onclick="editarContadorLuz(${c.id})" class="bg-yellow-600 text-white p-2 rounded-lg hover:bg-yellow-700 text-xs md:text-sm">‚úèÔ∏è</button>
                            <button onclick="removerContadorLuz(${c.id})" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 text-xs md:text-sm">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            if (dados.leituras.length > 0) {
                document.getElementById('historico-leituras').innerHTML = `
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Hist√≥rico</h3>
                    <div class="space-y-3">
                        ${dados.leituras.map(l => {
                            if (editandoLeitura && editandoLeitura.id === l.id) {
                                return `
                                    <div class="bg-white border-2 border-indigo-500 rounded-lg p-3 md:p-4">
                                        <div class="mb-4">
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">Data</label>
                                            <input type="date" value="${editandoLeitura.data}" onchange="editandoLeitura.data = this.value" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        </div>
                                        <div class="mb-4">
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">üè† Casa Principal</label>
                                            <div class="grid grid-cols-2 gap-4">
                                                <input type="number" step="1" value="${editandoLeitura.principalAgua}" onchange="editandoLeitura.principalAgua = parseInt(this.value)" class="px-3 py-2 border rounded" placeholder="√Ågua">
                                                <input type="number" step="1" value="${editandoLeitura.principalLuz}" onchange="editandoLeitura.principalLuz = parseInt(this.value)" class="px-3 py-2 border rounded" placeholder="Luz">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <p class="font-semibold text-blue-600 mb-3">√Ågua Terrenos:</p>
                                                ${editandoLeitura.agua.map((a, idx) => `
                                                    <div class="mb-2">
                                                        <label class="text-xs text-gray-600">${a.descricao}</label>
                                                        <input type="number" step="1" value="${a.valor}" onchange="editandoLeitura.agua[${idx}].valor = parseInt(this.value)" class="w-full px-3 py-1 text-sm border rounded">
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div>
                                                <p class="font-semibold text-yellow-600 mb-3">Luz Terrenos:</p>
                                                ${editandoLeitura.luz.map((lz, idx) => `
                                                    <div class="mb-2">
                                                        <label class="text-xs text-gray-600">${lz.descricao}</label>
                                                        <input type="number" step="1" value="${lz.valor}" onchange="editandoLeitura.luz[${idx}].valor = parseInt(this.value)" class="w-full px-3 py-1 text-sm border rounded">
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="salvarEdicaoLeitura()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">‚úì Guardar</button>
                                            <button onclick="cancelarEdicaoLeitura()" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">‚úï Cancelar</button>
                                        </div>
                                    </div>
                                `;
                            }
                            return `
                                <div class="bg-white border border-gray-200 rounded-lg p-3 md:p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <p class="font-bold text-gray-800">${new Date(l.data).toLocaleDateString('pt-PT')}</p>
                                            <p class="text-sm text-gray-600">Casa: ${l.principalAgua} / ${l.principalLuz}</p>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="editarLeitura(${l.id})" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">‚úèÔ∏è</button>
                                            <button onclick="eliminarLeitura(${l.id})" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <p class="font-semibold text-blue-600 mb-2">√Ågua Terrenos:</p>
                                            ${l.agua.map(a => `<p class="text-gray-600">${a.descricao}: ${a.valor}</p>`).join('')}
                                        </div>
                                        <div>
                                            <p class="font-semibold text-yellow-600 mb-2">Luz Terrenos:</p>
                                            ${l.luz.map(lz => `<p class="text-gray-600">${lz.descricao}: ${lz.valor}</p>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            if (dados.faturas.length > 0) {
                document.getElementById('historico-faturas').innerHTML = `
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4">Hist√≥rico</h3>
                    <div class="space-y-3 max-w-2xl mx-auto">
                        ${dados.faturas.map(f => {
                            if (editandoFatura && editandoFatura.id === f.id) {
                                return `
                                    <div class="bg-white border-2 border-indigo-500 rounded-lg p-3 md:p-4">
                                        <div class="mb-4">
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">M√™s</label>
                                            <input type="month" value="${editandoFatura.mes}" onchange="editandoFatura.mes = this.value" class="w-full px-4 py-2 border rounded-lg">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">√Ågua (‚Ç¨)</label>
                                                <input type="number" step="0.01" value="${editandoFatura.agua}" onchange="editandoFatura.agua = parseFloat(this.value)" class="w-full px-4 py-2 border rounded-lg">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">Luz (‚Ç¨)</label>
                                                <input type="number" step="0.01" value="${editandoFatura.luz}" onchange="editandoFatura.luz = parseFloat(this.value)" class="w-full px-4 py-2 border rounded-lg">
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="salvarEdicaoFatura()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">‚úì Guardar</button>
                                            <button onclick="cancelarEdicaoFatura()" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">‚úï Cancelar</button>
                                        </div>
                                    </div>
                                `;
                            }
                            return `
                                <div class="bg-white border border-gray-200 rounded-lg p-3 md:p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <p class="font-bold text-gray-800">${new Date(f.mes + '-01').toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' })}</p>
                                        <div class="flex gap-2">
                                            <button onclick="editarFatura(${f.id})" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">‚úèÔ∏è</button>
                                            <button onclick="eliminarFatura(${f.id})" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <p class="text-gray-600">√Ågua: ${f.agua.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-gray-600">Luz: ${f.luz.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <p class="font-bold text-indigo-600 mt-2">Total: ${(f.agua + f.luz).toFixed(2)} ‚Ç¨</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>